<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 关于iOS和OS X废弃的API你需要知道的一切 · Coding With MoreFun</title><meta name="description" content="关于iOS和OS X废弃的API你需要知道的一切 - Tinghui"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://blog.morefun.mobi/atom.xml" title="Coding With MoreFun"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/Tinghui" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="mailto:tinghui.zhang3@gmail.com" target="_self" class="nav-list-link">EMAIL</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">关于iOS和OS X废弃的API你需要知道的一切</h1><div class="post-info">2014年2月11日</div><div class="post-content"><p>已废弃(Deprecated)的API指的是那些已经过时并且在将来某个时间最终会被移除掉的方法或类。通常，苹果在引入一个更优秀的API后就会把原来的API给废弃掉。因为，新引入的API通常意味着可以更好的发挥新硬件或操作系统的性能，或者可以使用一些在构建原有API时根本还没有的语言特性(e.g. blocks)。</p>
<p>每当苹果添加新方法的时候，他们都会在方法声明的后面用一个很特殊的宏来标明哪些iOS版本支持它们。例如，在UIViewController中，苹果引入了一个使用block来处理回调的方法用来展示一个模态controller，它的声明是这样的：</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)presentViewController:(<span class="built_in">UIViewController</span> *)viewControllerToPresent animated: (<span class="built_in">BOOL</span>)flag completion:(<span class="keyword">void</span> (^)(<span class="keyword">void</span>))completion <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">5</span>_0);</div></pre></td></tr></table></figure>
<p>注意到<code>NS_AVAILABLE_IOS(5_0)</code>了吗？这就告诉我们这个方法可以在iOS5.0及以后的版本中使用。如果我们在比指定版本更老的版本中调用这个方法，就会引起崩溃。</p>
<a id="more"></a>
<p>那被这个方法替换了的那个旧方法又怎么样了呢？同样，它的声明后面也带了一个类似的语法，表示它已经被废弃了：</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)presentModalViewController:(<span class="built_in">UIViewController</span> *)modalViewController animated:(<span class="built_in">BOOL</span>)animated <span class="built_in">NS_DEPRECATED_IOS</span>(<span class="number">2</span>_0, <span class="number">6</span>_0);</div></pre></td></tr></table></figure>
<p><code>NS_DEPRECATED_IOS(2_0, 6_0)</code>这个宏中有两个版本号。前面一个表明了这个方法被引入时的iOS版本，后面一个表明它被废弃时的iOS版本。被废弃并不是指这个方法就不存在了，只是意味着我们应当开始考虑将相关代码迁移到新的API上去了。</p>
<p>还有类似形式的一些宏用在iOS和OS X共用的类上。比如NSArray中的这个方法：</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)setObject:(<span class="keyword">id</span>)obj atIndexedSubscript:(<span class="built_in">NSUInteger</span>)idx <span class="built_in">NS_AVAILABLE</span>(<span class="number">10</span>_8, <span class="number">6</span>_0);</div></pre></td></tr></table></figure>
<p>这里的NS_AVAILABLE宏告诉我们这方法分别随Mac OS 10.8和iOS 6.0被引入。和NS_DEPRECATED_IOS类似，也有个宏叫NS_DEPRECATED，但它的参数要稍微复杂些：</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)removeObjectsFromIndices:(<span class="built_in">NSUInteger</span> *)indices numIndices:(<span class="built_in">NSUInteger</span>)cnt <span class="built_in">NS_DEPRECATED</span>(<span class="number">10</span>_0, <span class="number">10</span>_6, <span class="number">2</span>_0, <span class="number">4</span>_0);</div></pre></td></tr></table></figure>
<p>这里表示这个方法随Mac OS 10.0和iOS 2.0被引入，在Mac OS 10.6和iOS 4.0后被废弃。</p>
<h3 id="来的快，去的也快"><a href="#来的快，去的也快" class="headerlink" title="来的快，去的也快"></a>来的快，去的也快</h3><p>上周我们讨论了在iOS7和Mac OS 10.9 SDK中被新引入的Base64 API。有趣的是，有一组有相同功能的Base64方法，在被引入的同时也被废弃掉了。为什么苹果在引入一个API的同时又把它废弃掉了？那不是毫无意义的吗？好吧，其实也不是——它在下面这种情况下就非常有意义：</p>
<p>实际上，这些现在已经废弃的Base64方法从iOS4和Mac 0S 10.6开始就一直存在，只是它们是私有的。直到现在苹果才把它们公开，大概是苹果一直对它们的实现不满意，一直都想把它们改写。</p>
<p>果然，在iOS7中，苹果选定了一个他们感到满意的Base64 API，并且将它添加到了NSData的一个公有类别中。但现在，他们知道老方法已经被取代，不会被改写了，因此他们把它公开出来。当开发者的app仍然需要支持iOS6及以前的版本时，就有了一个系统内置的Base64 api可以用。</p>
<p>这就是为什么，如果你查看这些新API的方法声明，可以看到NS_DEPRECATED宏部分中的起始版本是4_0，虽然实际上直到iOS7之前，它从来都没有被作为公有API被引入过：</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line">- (<span class="built_in">NSString</span> *)base64Encoding <span class="built_in">NS_DEPRECATED</span>(<span class="number">10</span>_6, <span class="number">10</span>_9, <span class="number">4</span>_0, <span class="number">7</span>_0);</div></pre></td></tr></table></figure>
<p>这告诉你，基于iOS7 SDK开发的app如果调用了这个方法，它同样可以运行在iOS4+或Mac OS 10.6+的系统上而不会崩溃。很有用，对吧？</p>
<h3 id="如何使用已废弃的API"><a href="#如何使用已废弃的API" class="headerlink" title="如何使用已废弃的API"></a>如何使用已废弃的API</h3><p>那么，如果我们有一个app需要同时支持iOS6和iOS7，想用内置的Base64方法，我们该怎么做呢？事实上，这相当简单，你只需要调用这些废弃的API就可以了。</p>
<p>那样编译器不是会产生警告吗？不会——只有你的deployment target版本号设置成大于或等于方法被弃用的版本号的时候才会收到编译器警告。只要你仍然在支持那些还没有废弃这个方法的iOS版本，都不会收到警告。</p>
<p>那么，如果苹果决定在iOS8中移除已弃用的Base64方法，你的应用程序会发生情况？简单来说，它肯定会崩溃，但是不要让这把你吓跑了：苹果不可能只在几个iOS版本后就将已废弃的API给移除(绝大多数已废弃的API在任何的iOS版本中都还没有被移除)，除非你决定不再更新你的app，否则在你放弃支持iOS6之前有很多机会都可以更新到新的API。</p>
<p>但是如果假定我们在最坏的情况下(例如：我们不更新我们的app了，而苹果突然宣布了一个零容忍的不再向下兼容的政策)，怎样让我们的代码保持永不过时并且仍然能够支持旧的系统版本呢？</p>
<p>这其实很简单，我们只需要做一些运行时的方法检测。使用NSObject的<code>respondsToSelector:</code>方法，我们可以检测，如果新的API存在，我们就调用它。否则，我们退回到已废弃的API。很简单：</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"><span class="built_in">NSData</span> *someData = ...</div><div class="line"><span class="built_in">NSString</span> *base64String = <span class="literal">nil</span>;</div><div class="line"> </div><div class="line"><span class="comment">// Check if new API is available</span></div><div class="line"><span class="keyword">if</span> ([someData respondsToSelector:<span class="keyword">@selector</span>(base64EncodedDataWithOptions:)])</div><div class="line">&#123;</div><div class="line">  <span class="comment">// It exists, so let's call it</span></div><div class="line">  base64String = [someData base64EncodedDataWithOptions:<span class="number">0</span>];</div><div class="line">&#125;</div><div class="line"><span class="keyword">else</span></div><div class="line">&#123;</div><div class="line">  <span class="comment">// Use the old API</span></div><div class="line">  base64String = [someData base64Encoding];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>此代码在iOS4及以上版本中有效，并且如果苹果在未来的iOS版本中移除base64Encoding方法后，同样可以正常工作。</p>
<h3 id="开发SDK的时候"><a href="#开发SDK的时候" class="headerlink" title="开发SDK的时候"></a>开发SDK的时候</h3><p>如果你是在写一个app，这一切都还好。但是如果你是在编写一个给其他人使用的库呢？如果project的target是iOS4或iOS6的时候，上面的代码会工作的很好。但是如果deployment target是iOS7+的时候，你就会收到编译警告，说你使用了已废弃的base64Encoding方法。</p>
<p>该代码实际上可以正常工作，因为那个方法在运行时永远都不会被调用(因为respondsToSelector:那个检查在iOS7上总是会返回YES)。可惜编译器还是不足够聪明，不能发现这点。而且，比如像我，不会想用那些会产生编译警告的第三方库，你肯定也不想自己的库中产生任何警告。 </p>
<p>那么，我们如何改写代码，以便它可以用于任何deployment target，而不会产生警告？幸好，有一个编译器宏指令可以基于不同的deployment target做不同的代码分支。取决于最终app的支持的最小iOS版本，我们可以用<code>__IPHONE_OS_VERSION_MIN_REQUIRED</code>这个宏来生成不同的代码。</p>
<p>下面的代码可以工作在任何的iOS版本上，而且不会产生任何警告：</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"><span class="meta">#if __IPHONE_OS_VERSION_MIN_REQUIRED <span class="meta-string">&lt; __IPHONE_7_0</span></span></div><div class="line"> </div><div class="line">// Check if new API is not available</div><div class="line">if (![someData respondsToSelector:@selector(base64EncodedDataWithOptions:)])</div><div class="line">&#123;</div><div class="line">	// Use the old API</div><div class="line">	base64String = [someData base64Encoding];</div><div class="line">&#125;</div><div class="line">else</div><div class="line"> </div><div class="line">#endif</div><div class="line"> </div><div class="line">&#123;</div><div class="line">	// Use the new API</div><div class="line">	base64String = [someData base64EncodedDataWithOptions:0];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>看清楚我们在这里做了什么吗？我们变换了respondsToSelector:的用法：我们用它来测试是否新的API不可用，然后将整段代码放到一个条件代码块中，这样它就只会在deployment target比iOS7低的情况下才会被编译。如果app是为iOS6编译的，它就会先检查新的API是否存在，如果不存在就调用旧的API。如果app是为iOS7编译的，那一整块逻辑代码都会被跳过，直接调用新的API。</p>
<h3 id="补充阅读"><a href="#补充阅读" class="headerlink" title="补充阅读"></a>补充阅读</h3><p>苹果有一个关于<a href="https://developer.apple.com/library/mac/documentation/DeveloperTools/Conceptual/cross_development/Using/using.html#//apple_ref/doc/uid/20002000-SW5" target="_blank" rel="external">废弃API用法的实例和相关的编译器警告</a>的简单文档，如果感兴趣可以看看。</p>
<p>原文: <a href="http://iosdevelopertips.com/best-practices/eveything-you-need-to-know-about-ios-and-os-x-deprecated-apis.html" target="_blank" rel="external">Everything You Need to Know about iOS and OS X Deprecated APIs</a></p>
<p style="text-align:center"><img src="/images/posts/thx_money.png" width="50%" height="50%"></p></div></article></div></main><footer><div class="paginator"><a href="/2014/03/16/2014-03-16-yi-adopting-modern-objective-c/" class="prev">上一篇</a><a href="/2014/01/08/2014-01-08-uiapplicationdelegate-launchoptions/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'rockonmycode';
var disqus_identifier = '2014/02/11/2014-02-11-ni-xu-yao-zhi-dao-de-suo-you-guan-yu-ioshe-os-xyi-qi-yong-de-apide-shi-er/';
var disqus_title = '关于iOS和OS X废弃的API你需要知道的一切';
var disqus_url = 'http://blog.morefun.mobi/2014/02/11/2014-02-11-ni-xu-yao-zhi-dao-de-suo-you-guan-yu-ioshe-os-xyi-qi-yong-de-apide-shi-er/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//rockonmycode.disqus.com/count.js" async></script><div class="copyright"><p>© 2012 - 2018 <a href="http://blog.morefun.mobi">Tinghui</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>