<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 使用NSSecureCoding协议进行编解码 · Morefun With Coding</title><meta name="description" content="使用NSSecureCoding协议进行编解码 - Tinghui"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://blog.morefun.mobi/atom.xml" title="Morefun With Coding"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/Tinghui" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="mailto:tinghui.zhang3@gmail.com" target="_self" class="nav-list-link">EMAIL</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">使用NSSecureCoding协议进行编解码</h1><div class="post-info">2014年4月15日</div><div class="post-content"><p>在iOS和Mac OS上，<code>NSCoding</code>是一种简单方便的数据存储方法。它可以直接将你的数据模型对象写入一个文件，之后又可以直接将它们读入内存而不需要编写任何文件解析和序列化的逻辑。将一个对象（假设它已经实现了NSCoding协议）保存至一个文件，只需要这样做：</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line">Foo *someFoo = [[Foo alloc] init];</div><div class="line">[<span class="built_in">NSKeyedArchiver</span> archiveRootObject:someFoo toFile:someFile];</div></pre></td></tr></table></figure>
<p>之后要加载时，只需要这样：</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line">Foo *someFoo = [<span class="built_in">NSKeyedUnarchiver</span> unarchiveObjectWithFile:someFile];</div></pre></td></tr></table></figure>
<a id="more"></a>
<p>那些编译到应用里面的资源采用这种方式挺好（比如nib文件，它其实就是用的NSCoding方式），但是使用NSCoding读写用户数据文件的问题在于，由于你是将整个类编码进一个文件，因此在你的应用中就隐式的赋予了该文件实例化类对象的权限。</p>
<p>虽然你不能在一个被NSCoding的文件中存储可执行代码（至少在iOS上不行），但黑客可能会用一个特制的文件欺骗你的应用，来实例化一个你意想不到的类对象，或者在一个你想象不到的环境下实例化类对象。虽然这样做很难带来任何真正的伤害，但这肯定会导致应用崩溃或用户数据丢失。</p>
<p>iOS6中，苹果引入了一个基于NSCoding的新协议，叫做<code>NSSecureCoding</code>。NSSecureCoding和NSCoding几乎完全相同，除了解码的时候你需要指定要解码的对象的key和类，并且如果指定的类和从文件解码到的对象的类不匹配的时候，NSCoder会抛出一个异常来告诉你该数据已经被篡改。</p>
<p>大多数支持NSCoding的系统对象都已经升级到支持NSSecureCoding，所以给你的NSKeyedUnarchiver设置要求使用安全编码(secure coding)功能，就可以确保你加载到的数据文件是安全的。如下所示：</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Set up NSKeyedUnarchiver to use secure coding</span></div><div class="line"><span class="built_in">NSData</span> *data = [<span class="built_in">NSData</span> dataWithContentsOfFile:someFile];</div><div class="line"><span class="built_in">NSKeyedUnarchiver</span> *unarchiver = [[<span class="built_in">NSKeyedUnarchiver</span> alloc] initForReadingWithData:data];</div><div class="line">[unarchiver setRequiresSecureCoding:<span class="literal">YES</span>];</div><div class="line"> </div><div class="line"><span class="comment">// Decode object</span></div><div class="line">Foo *someFoo = [unarchiver decodeObjectForKey:<span class="built_in">NSKeyedArchiveRootObjectKey</span>];</div></pre></td></tr></table></figure>
<p>注意，如果使用NSKeyedUnarchiver的安全编码功能，那么存储在这个文件中的所有对象都必须遵循NSSecureCoding协议，否则你会得到一个异常。要让你的类支持NSSecureCoding协议，需要在<code>initWithCoder:</code>方法里面实现新的解码逻辑，并且要让<code>supportsSecureCoding</code>方法返回YES。<code>encodeWithCoder:</code>方法不需要修改，因为安全问题在读取过程中才可能出现，不会出现在保存的过程中。</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Foo</span> : <span class="title">NSObject</span> </span></div><div class="line"> </div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSNumber</span> *property1;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSArray</span> *property2;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *property3;</div><div class="line"> </div><div class="line"><span class="keyword">@end</span></div><div class="line"> </div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Foo</span></span></div><div class="line"> </div><div class="line">+ (<span class="built_in">BOOL</span>)supportsSecureCoding</div><div class="line">&#123;</div><div class="line">  <span class="keyword">return</span> <span class="literal">YES</span>;</div><div class="line">&#125;</div><div class="line"> </div><div class="line">- (<span class="keyword">id</span>)initWithCoder:(<span class="built_in">NSCoder</span> *)coder</div><div class="line">&#123;</div><div class="line">  <span class="keyword">if</span> ((<span class="keyword">self</span> = [<span class="keyword">super</span> init]))</div><div class="line">  &#123;</div><div class="line">    <span class="comment">// Decode the property values by key, specifying the expected class</span></div><div class="line">    _property1 = [coder decodeObjectOfClass:[<span class="built_in">NSNumber</span> <span class="keyword">class</span>] forKey:<span class="string">@"property1"</span>];</div><div class="line">    _property2 = [coder decodeObjectOfClass:[<span class="built_in">NSArray</span> <span class="keyword">class</span>] forKey:<span class="string">@"property2"</span>];</div><div class="line">    _property3 = [coder decodeObjectOfClass:[<span class="built_in">NSString</span> <span class="keyword">class</span>] forKey:<span class="string">@"property3"</span>];</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div><div class="line"> </div><div class="line">- (<span class="keyword">void</span>)encodeWithCoder:(<span class="built_in">NSCoder</span> *)coder</div><div class="line">&#123;</div><div class="line">  <span class="comment">// Encode our ivars using string keys as normal</span></div><div class="line">  [coder encodeObject:_property1 forKey:<span class="string">@"property1"</span>];</div><div class="line">  [coder encodeObject:_property2 forKey:<span class="string">@"property2"</span>];</div><div class="line">  [coder encodeObject:_property3 forKey:<span class="string">@"property3"</span>];</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>几周前，我写了「<a href="http://iosdevelopertips.com/cocoa/nscoding-without-boilerplate.html" target="_blank" rel="external">如何在运行时通过内省(introspection)来检测类的属性，以实现自动NSCoding</a>」。</p>
<p>这是一个非常棒的方法，它能一下子让你的所有的模型对象都支持NSCoding，而无需重复的编写initWithCoder:和encodeWithCoder:方法，从而也减少了出错的几率。但是我们使用的这个方法不支持NSSecureCoding，因为我们无法对正在加载的对象进行类型验证。</p>
<p>那么，如何增强我们的自动NSCoding系统以支持NSSecureCoding呢？</p>
<p>如果你还记得，原有的实现是使用了<code>class_copyPropertyList()</code>和<code>property_getName()</code>这两个运行时函数来生成了一组属性名字，然后我们将它们存入了一个数组：</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"><span class="comment">//引入Objective-C运行时的头文件</span></div><div class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span> </span></div><div class="line"> </div><div class="line">- (<span class="built_in">NSArray</span> *)propertyNames</div><div class="line">&#123;    </div><div class="line">  <span class="comment">//获得属性列表</span></div><div class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> propertyCount;</div><div class="line">  objc_property_t *properties = class_copyPropertyList([<span class="keyword">self</span> <span class="keyword">class</span>], </div><div class="line">    &amp;propertyCount);</div><div class="line">  <span class="built_in">NSMutableArray</span> *array = [<span class="built_in">NSMutableArray</span> arrayWithCapacity:propertyCount];</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; propertyCount; i++)</div><div class="line">  &#123;</div><div class="line">    <span class="comment">//获得属性名字</span></div><div class="line">    objc_property_t property = properties[i];</div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *propertyName = property_getName(property);</div><div class="line">    <span class="built_in">NSString</span> *key = @(propertyName);</div><div class="line"> </div><div class="line">    <span class="comment">//加入数组中</span></div><div class="line">    [array addObject:key];</div><div class="line">  &#125;</div><div class="line"> </div><div class="line">  <span class="comment">//记得释放属性列表，因为ARC不会替我们释放它</span></div><div class="line">  free(properties);</div><div class="line"> </div><div class="line">  <span class="keyword">return</span> array;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过使用KVC,我们就能够通过名字来设置和获取一个对象的所有属性，并在一个NSCoder对象中将它们编码或解码。</p>
<p>实现自动NSSecureCoding时，我们也遵循相同的原则。但，除了获取属性的名字之外，我们还需要获取到其对应的类型。幸运的是，Objective-C的运行时存储了类属性的类型信息，所以获取名字的同时，获取类型数据也很容易。</p>
<p>类的属性可以是基本数据类型（如整型、布尔型和结构体），也可以是对象（如NSString、NSArray等等）。KVC的<code>valueForKey:</code>方法和<code>setValue:forKey:</code>方法实现了对基本数据类型的自动化“装箱（boxing）”操作。就是说，它们会将整型、布尔型和结构体这些基本数据类型转换成NSNumber或NSValue对象。这样，对我们来说就简单多了，因为我们只需要处理装箱后的对象就可以了。因此我们就能够将我们所有的属性类型按照类来处理，而不必为了不同的属性类型调用不同的解码方法。</p>
<p>虽然，运行时不会把每个属性装箱后对应的类名给我们，但它会给我们对应的类型编码信息——一个包含了类型信息的特殊格式的C字符串（与<code>@encode(var);</code>语法返回的字符串格式相同）。由于没有能够自动获取基本数据类型的等价类的方法，所以我们需要解析这个字符串，然后自己指定相应的类。</p>
<p>苹果官方描述类型编码字符串格式的文档在<a href="https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html" target="_blank" rel="external">这里</a>。</p>
<p>第一个字符就代表了对应的基本数据类型。Objective-C为每个支持的基本类型都定义了一个唯一的字符，比如‘i’表示一个整数，‘f’表示浮点数，‘d’表示double，等等。对象被表示为‘@’(后接类名)，还有另外一些生僻的类型，如‘:’表示selector，或‘#’表示类。</p>
<p>花括弧{…}包含起来的表达式代表struct和union类型。仅有一部分struct和union类型被KVC支持。KVC支持的这部分类型会被装箱成NSValue对象，因此我们可以将任何以‘{’开头的值都做同样的处理。</p>
<p>使用switch，基于字符串的第一个字符，我们就能够处理所有的已知类型：</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line">Class propertyClass = <span class="literal">nil</span>;</div><div class="line"><span class="keyword">char</span> *typeEncoding = property_copyAttributeValue(property, <span class="string">"T"</span>);</div><div class="line"><span class="keyword">switch</span> (typeEncoding[<span class="number">0</span>])</div><div class="line">&#123;</div><div class="line">  <span class="keyword">case</span> <span class="string">'c'</span>: <span class="comment">// Numeric types</span></div><div class="line">  <span class="keyword">case</span> <span class="string">'i'</span>:</div><div class="line">  <span class="keyword">case</span> <span class="string">'s'</span>:</div><div class="line">  <span class="keyword">case</span> <span class="string">'l'</span>:</div><div class="line">  <span class="keyword">case</span> <span class="string">'q'</span>:</div><div class="line">  <span class="keyword">case</span> <span class="string">'C'</span>:</div><div class="line">  <span class="keyword">case</span> <span class="string">'I'</span>:</div><div class="line">  <span class="keyword">case</span> <span class="string">'S'</span>:</div><div class="line">  <span class="keyword">case</span> <span class="string">'L'</span>:</div><div class="line">  <span class="keyword">case</span> <span class="string">'Q'</span>:</div><div class="line">  <span class="keyword">case</span> <span class="string">'f'</span>:</div><div class="line">  <span class="keyword">case</span> <span class="string">'d'</span>:</div><div class="line">  <span class="keyword">case</span> <span class="string">'B'</span>:</div><div class="line">  &#123;</div><div class="line">    propertyClass = [<span class="built_in">NSNumber</span> <span class="keyword">class</span>];</div><div class="line">    <span class="keyword">break</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">case</span> <span class="string">'*'</span>: <span class="comment">// C-String</span></div><div class="line">  &#123;</div><div class="line">    propertyClass = [<span class="built_in">NSString</span> <span class="keyword">class</span>];</div><div class="line">    <span class="keyword">break</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">case</span> <span class="string">'@'</span>: <span class="comment">// Object</span></div><div class="line">  &#123;</div><div class="line">    <span class="comment">//<span class="doctag">TODO:</span> get class name</span></div><div class="line">    <span class="keyword">break</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">case</span> <span class="string">'&#123;'</span>: <span class="comment">// Struct</span></div><div class="line">  &#123;</div><div class="line">    propertyClass = [<span class="built_in">NSValue</span> <span class="keyword">class</span>];</div><div class="line">    <span class="keyword">break</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">case</span> <span class="string">'['</span>: <span class="comment">// C-Array</span></div><div class="line">  <span class="keyword">case</span> <span class="string">'('</span>: <span class="comment">// Enum</span></div><div class="line">  <span class="keyword">case</span> <span class="string">'#'</span>: <span class="comment">// Class</span></div><div class="line">  <span class="keyword">case</span> <span class="string">':'</span>: <span class="comment">// Selector</span></div><div class="line">  <span class="keyword">case</span> <span class="string">'^'</span>: <span class="comment">// Pointer</span></div><div class="line">  <span class="keyword">case</span> <span class="string">'b'</span>: <span class="comment">// Bitfield</span></div><div class="line">  <span class="keyword">case</span> <span class="string">'?'</span>: <span class="comment">// Unknown type</span></div><div class="line">  <span class="keyword">default</span>:</div><div class="line">  &#123;</div><div class="line">    propertyClass = <span class="literal">nil</span>; <span class="comment">// Not supported by KVC</span></div><div class="line">    <span class="keyword">break</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">free(typeEncoding);</div></pre></td></tr></table></figure>
<p>要处理‘@’类型，我们还需要获得类名。类名可能包含了协议名，因此我们要把字符串进行分割，只提取出类名，然后使用NSClassFromString函数来获得对应的类：</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line"><span class="keyword">case</span> <span class="string">'@'</span>:</div><div class="line">&#123;</div><div class="line">  <span class="comment">//类的objcType只少3个字符长度</span></div><div class="line">  <span class="keyword">if</span> (strlen(typeEncoding) &gt;= <span class="number">3</span>)</div><div class="line">  &#123;</div><div class="line">    <span class="comment">//拷贝得到C字符串形式的类名</span></div><div class="line">    <span class="keyword">char</span> *cName = strndup(typeEncoding + <span class="number">2</span>, strlen(typeEncoding) - <span class="number">3</span>);</div><div class="line"> </div><div class="line">    <span class="comment">//转换为一个NSString，以便后续操作的处理</span></div><div class="line">    <span class="built_in">NSString</span> *name = @(cName);</div><div class="line"> </div><div class="line">    <span class="comment">//剔除类名后面的协议名字</span></div><div class="line">    <span class="built_in">NSRange</span> range = [name rangeOfString:<span class="string">@"&lt;"</span>];</div><div class="line">    <span class="keyword">if</span> (range.location != <span class="built_in">NSNotFound</span>)</div><div class="line">    &#123;</div><div class="line">      name = [name substringToIndex:range.location];</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="comment">//根据类名获取对应的类，如果没有对应的类则默认为NSObject</span></div><div class="line">    propertyClass = <span class="built_in">NSClassFromString</span>(name) ?: [<span class="built_in">NSObject</span> <span class="keyword">class</span>];</div><div class="line">    free(cName);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">break</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后，我们可以将这种解析逻辑与前面的实现中的propertyNames方法的逻辑组合起来，以属性名字作为key，创建一个返回包含属性对应类的字典的方法。下面是完整的实现：</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line">- (<span class="built_in">NSDictionary</span> *)propertyClassesByName</div><div class="line">&#123;</div><div class="line">  <span class="comment">// Check for a cached value (we use _cmd as the cache key, </span></div><div class="line">  <span class="comment">// which represents @selector(propertyNames))</span></div><div class="line">  <span class="built_in">NSMutableDictionary</span> *dictionary = objc_getAssociatedObject([<span class="keyword">self</span> <span class="keyword">class</span>], _cmd);</div><div class="line">  <span class="keyword">if</span> (dictionary)</div><div class="line">  &#123;</div><div class="line">      <span class="keyword">return</span> dictionary;</div><div class="line">  &#125;</div><div class="line"> </div><div class="line">  <span class="comment">// Loop through our superclasses until we hit NSObject</span></div><div class="line">  dictionary = [<span class="built_in">NSMutableDictionary</span> dictionary];</div><div class="line">  Class subclass = [<span class="keyword">self</span> <span class="keyword">class</span>];</div><div class="line">  <span class="keyword">while</span> (subclass != [<span class="built_in">NSObject</span> <span class="keyword">class</span>])</div><div class="line">  &#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> propertyCount;</div><div class="line">    objc_property_t *properties = class_copyPropertyList(subclass, </div><div class="line">      &amp;propertyCount);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; propertyCount; i++)</div><div class="line">    &#123;</div><div class="line">      <span class="comment">// Get property name</span></div><div class="line">      objc_property_t property = properties[i];</div><div class="line">      <span class="keyword">const</span> <span class="keyword">char</span> *propertyName = property_getName(property);</div><div class="line">      <span class="built_in">NSString</span> *key = @(propertyName);</div><div class="line"> </div><div class="line">      <span class="comment">// Check if there is a backing ivar</span></div><div class="line">      <span class="keyword">char</span> *ivar = property_copyAttributeValue(property, <span class="string">"V"</span>);</div><div class="line">      <span class="keyword">if</span> (ivar)</div><div class="line">      &#123;</div><div class="line">        <span class="comment">// Check if ivar has KVC-compliant name</span></div><div class="line">        <span class="built_in">NSString</span> *ivarName = @(ivar);</div><div class="line">        <span class="keyword">if</span> ([ivarName isEqualToString:key] || </div><div class="line">          [ivarName isEqualToString:[<span class="string">@"_"</span> stringByAppendingString:key]])</div><div class="line">        &#123;</div><div class="line">          <span class="comment">// Get type</span></div><div class="line">          Class propertyClass = <span class="literal">nil</span>;</div><div class="line">          <span class="keyword">char</span> *typeEncoding = property_copyAttributeValue(property, <span class="string">"T"</span>);</div><div class="line">          <span class="keyword">switch</span> (typeEncoding[<span class="number">0</span>])</div><div class="line">          &#123;</div><div class="line">            <span class="keyword">case</span> <span class="string">'c'</span>: <span class="comment">// Numeric types</span></div><div class="line">            <span class="keyword">case</span> <span class="string">'i'</span>:</div><div class="line">            <span class="keyword">case</span> <span class="string">'s'</span>:</div><div class="line">            <span class="keyword">case</span> <span class="string">'l'</span>:</div><div class="line">            <span class="keyword">case</span> <span class="string">'q'</span>:</div><div class="line">            <span class="keyword">case</span> <span class="string">'C'</span>:</div><div class="line">            <span class="keyword">case</span> <span class="string">'I'</span>:</div><div class="line">            <span class="keyword">case</span> <span class="string">'S'</span>:</div><div class="line">            <span class="keyword">case</span> <span class="string">'L'</span>:</div><div class="line">            <span class="keyword">case</span> <span class="string">'Q'</span>:</div><div class="line">            <span class="keyword">case</span> <span class="string">'f'</span>:</div><div class="line">            <span class="keyword">case</span> <span class="string">'d'</span>:</div><div class="line">            <span class="keyword">case</span> <span class="string">'B'</span>:</div><div class="line">            &#123;</div><div class="line">              propertyClass = [<span class="built_in">NSNumber</span> <span class="keyword">class</span>];</div><div class="line">              <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">case</span> <span class="string">'*'</span>: <span class="comment">// C-String</span></div><div class="line">            &#123;</div><div class="line">              propertyClass = [<span class="built_in">NSString</span> <span class="keyword">class</span>];</div><div class="line">              <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">case</span> <span class="string">'@'</span>: <span class="comment">// Object</span></div><div class="line">            &#123;</div><div class="line">              <span class="comment">//<span class="doctag">TODO:</span> get class name</span></div><div class="line">              <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">case</span> <span class="string">'&#123;'</span>: <span class="comment">// Struct</span></div><div class="line">            &#123;</div><div class="line">              propertyClass = [<span class="built_in">NSValue</span> <span class="keyword">class</span>];</div><div class="line">              <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">case</span> <span class="string">'['</span>: <span class="comment">// C-Array</span></div><div class="line">            <span class="keyword">case</span> <span class="string">'('</span>: <span class="comment">// Enum</span></div><div class="line">            <span class="keyword">case</span> <span class="string">'#'</span>: <span class="comment">// Class</span></div><div class="line">            <span class="keyword">case</span> <span class="string">':'</span>: <span class="comment">// Selector</span></div><div class="line">            <span class="keyword">case</span> <span class="string">'^'</span>: <span class="comment">// Pointer</span></div><div class="line">            <span class="keyword">case</span> <span class="string">'b'</span>: <span class="comment">// Bitfield</span></div><div class="line">            <span class="keyword">case</span> <span class="string">'?'</span>: <span class="comment">// Unknown type</span></div><div class="line">            <span class="keyword">default</span>:</div><div class="line">            &#123;</div><div class="line">              propertyClass = <span class="literal">nil</span>; <span class="comment">// Not supported by KVC</span></div><div class="line">              <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">          free(typeEncoding);</div><div class="line"> </div><div class="line">          <span class="comment">// If known type, add to dictionary</span></div><div class="line">          <span class="keyword">if</span> (propertyClass) dictionary[propertyName] = propertyClass;</div><div class="line">        &#125;</div><div class="line">        free(ivar);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    free(properties);</div><div class="line">    subclass = [subclass superclass];</div><div class="line">  &#125;</div><div class="line"> </div><div class="line">  <span class="comment">// Cache and return dictionary</span></div><div class="line">  objc_setAssociatedObject([<span class="keyword">self</span> <span class="keyword">class</span>], _cmd, dictionary, </div><div class="line">    OBJC_ASSOCIATION_RETAIN_NONATOMIC);</div><div class="line">  <span class="keyword">return</span> dictionary;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最困难的部分已经完成。现在，要实现NSSecureCoding，我们只需要修改前面实现自动化逻辑的代码中的initWithCoder:方法，接收属性对应类以进行解析操作。同样，我们还需要让supportsSecureCoding方法返回YES：</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><div class="line">+ (<span class="built_in">BOOL</span>)supportsSecureCoding</div><div class="line">&#123;</div><div class="line">  <span class="keyword">return</span> <span class="literal">YES</span>;</div><div class="line">&#125;</div><div class="line"> </div><div class="line">- (<span class="keyword">id</span>)initWithCoder:(<span class="built_in">NSCoder</span> *)coder</div><div class="line">&#123;</div><div class="line">  <span class="keyword">if</span> ((<span class="keyword">self</span> = [<span class="keyword">super</span> init]))</div><div class="line">  &#123;</div><div class="line">    <span class="comment">// Decode the property values by key, specifying the expected class</span></div><div class="line">    [[<span class="keyword">self</span> propertyClassesByName] enumerateKeysAndObjectsUsingBlock:(<span class="keyword">void</span> (^)(<span class="built_in">NSString</span> *key, Class propertyClass, <span class="built_in">BOOL</span> *stop)) &#123;</div><div class="line">      <span class="keyword">id</span> object = [aDecoder decodeObjectOfClass:propertyClass forKey:key];</div><div class="line">      <span class="keyword">if</span> (object) [<span class="keyword">self</span> setValue:object forKey:key];</div><div class="line">    &#125;];</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div><div class="line"> </div><div class="line">- (<span class="keyword">void</span>)encodeWithCoder:(<span class="built_in">NSCoder</span> *)aCoder</div><div class="line">&#123;</div><div class="line">  <span class="keyword">for</span> (<span class="built_in">NSString</span> *key <span class="keyword">in</span> [<span class="keyword">self</span> propertyClassesByName])</div><div class="line">  &#123;</div><div class="line">    <span class="keyword">id</span> object = [<span class="keyword">self</span> valueForKey:key];</div><div class="line">    <span class="keyword">if</span> (object) [aCoder encodeObject:object forKey:key];</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>好了，现在你的模型类已经拥有了一个可以打开即用的支持NSSecureCoding的简单基类。另外，你也可以直接使用我写的一个叫<code>AutoCoding</code>的分类，它正是使用了上述方法来为任何一个没有实现NSCoding和NSSecureCoding协议的对象加入自动NSCoding和NSSecureCoding能力。</p>
<p>译自：<a href="http://iosdevelopertips.com/general/object-encoding-and-decoding-with-nssecurecoding.html" target="_blank" rel="external">Object Encoding and Decoding with NSSecureCoding Protocol</a></p>
<p>原文作者为<a href="https://twitter.com/nicklockwood" target="_blank" rel="external">Nick Lockwood</a>，他是<a href="http://www.informit.com/store/ios-core-animation-advanced-techniques-9780133440751" target="_blank" rel="external">《iOS Core Animation: Advanced Techniques》</a>一书的作者，也是iCarousel、iRate等开源项目的作者。</p>
<p style="text-align:center"><img src="/images/posts/thx_money.png" width="30%" height="30%"></p></div></article></div></main><footer><div class="paginator"><a href="/2014/05/17/2014-05-17-yi-model-view-viewmodel-for-ios/" class="prev">上一篇</a><a href="/2014/03/21/2014-03-21-yi-7chong-chang-jian-de-dai-ma-wen-ti/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'rockonmycode';
var disqus_identifier = '2014/04/15/2014-04-15-shi-yong-nssecurecodingxie-yi-jin-xing-bian-jie-ma/';
var disqus_title = '使用NSSecureCoding协议进行编解码';
var disqus_url = 'http://blog.morefun.mobi/2014/04/15/2014-04-15-shi-yong-nssecurecodingxie-yi-jin-xing-bian-jie-ma/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//rockonmycode.disqus.com/count.js" async></script><div class="copyright"><p>© 2012 - 2017 <a href="http://blog.morefun.mobi">Tinghui</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>